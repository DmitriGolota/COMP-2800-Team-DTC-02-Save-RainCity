<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Save Raincity - Profile</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">

  <!--StyleSheets-->
  <link rel="stylesheet" href="./styles/header.css">
  <link rel="stylesheet" href="./styles/profile.css">
  <link rel="stylesheet" href="./styles/footer.css">

  <!--Favicon-->
  <link rel="icon" href="./assets/SRC-Favicon.png">
  <!-- BEGIN SHAREAHOLIC CODE -->
  <link rel="preload" href="https://cdn.shareaholic.net/assets/pub/shareaholic.js" as="script" />
  <meta name="shareaholic:site_id" content="6d3c6d0a608ad5d8a637d8890316f3e5" />
  <script data-cfasync="false" async src="https://cdn.shareaholic.net/assets/pub/shareaholic.js"></script>
  <!-- END SHAREAHOLIC CODE -->
</head>

<body>
  <header>
    <nav class="navbar navbar-dark bg-dark main-background">
      <div class="container-fluid">
        <a class="navbar-brand" href="index.html">
          <div class="logo"></div>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link main-link" href="profile.html">Profile</a>
            </li>
            <li class="nav-item">
              <a class="nav-link main-link" href="ceap.html">CEAP Information</a>
            </li>
            <li class="nav-item">
              <a class="nav-link main-link" href="aboutUs.html">About the Devs</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </header>

  <section class="content">
    <h1 class="blue">Name</h1>
    <p id="usersName">N/A</p>
    <button id="changeNameButton">Change Name</button>
  </section>
  <section id="table" class="content">
    <table>
      <tr id="scoresGoHere">
        <th>
          <h1 class="green">Personal Highscores</h1>
        </th>
      </tr>
    </table>
  </section>
  <section class="content bottom-box">
    <h1 class="red">Delete Account</h1>
    <button id="deleteAccountButton">Click here to permanently delete your account</button>
  </section>
  <footer>
    <section class="about">
      <h4>About the project</h4>
      <p class="footerDescription"> A group of developers come together to create a fun and interactive game to teach
        Vancouverites about the Climate Emergency Action Plan.</p>
    </section>
    <aside>
      <h4>Navigation</h4>
      <ul>
        <li>
          <a href="./index.html">Home</a>
        </li>
        <li>
          <a href="./ceap.html">CEAP info</a>
        </li>
        <li>
          <a href="./aboutUs.html">About the devs</a>
        </li>
      </ul>
    </aside>
  </footer>


  <!----------------------------------------------->
  <!-- JS: Boostrap, JQuery, Firebase, API related    -->
  <!----------------------------------------------->

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/ui/4.8.0/firebase-ui-auth.js"></script>

  <!-- Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0"
    crossorigin="anonymous"></script>

  <!-- Jquery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  <!-- Link to the api key for our firebase project -->
  <script src="./server/firebase_api_saveraincity.js"></script>

  <!--------------------------------------------------------------------->
  <!-- JS files: Your own JavaScript functions included here    -->
  <!--------------------------------------------------------------------->
  <script>

    // Add event listener for delete account button and name change button
    document.getElementById('deleteAccountButton').addEventListener('click', deleteAccount);
    document.getElementById('changeNameButton').addEventListener('click', changeUserName);

    // Reference to user's name text field
    let userNameField = document.getElementById('usersName');

    // Set user's textcontent under Name header to name from firestore
    firebase.auth().onAuthStateChanged(function (user) {
      if (user) {
        db.collection('users').doc(user.uid)
          .get()
          .then(function (doc) {
            userNameField.textContent = doc.data().name;
          })
        db.collection('users').doc(user.uid)
          .collection('game-scores')
          .orderBy('score', 'desc')
          .limit(5)
          .get()
          .then(function (snap) {
            let referenceToHighscores = document.getElementById('scoresGoHere');
            snap.forEach(function (doc) {
              let score = doc.data().score;
              let time = doc.data().timestamp;

              let tableRow = document.createElement('tr');
              let tableData = document.createElement('td');
              tableData.innerHTML = '<span class="blue">Score:</span> ' + score + ' <span class="blue">Date:</span> ' + time;
              tableRow.appendChild(tableData)
              referenceToHighscores.after(tableRow);
            })
          })
      } else {
        window.location.assign('/index.html')
      }
    })

    // Update user's name to input from user
    function changeUserName() {
      firebase.auth().onAuthStateChanged(function (user) {
        if (user) {
          let inputFromPrompt = prompt('Please enter your new name and select OK to change your name.')
          if (inputFromPrompt != null) {
            db.collection('users').doc(user.uid)
              .update({
                name: inputFromPrompt
              })
              .then(() => {
                userNameField.textContent = inputFromPrompt;
              })
          }

        };
      })
    };


    // Delete user's account if they enter their name correctly into prompt
    function deleteAccount() {
      firebase.auth().onAuthStateChanged(function (user) {
        if (user) {
          let inputFromPrompt = prompt('Please enter your full name and select OK to delete your account.')
          db.collection('users').doc(user.uid)
            .get()
            .then(function (doc) {
              if (inputFromPrompt === doc.data().name) {
                db.collection("users").doc(user.uid).delete().then(() => {
                  console.log("Document successfully deleted!");
                }).catch((error) => {
                  console.error("Error removing document: ", error);
                });
                user.delete().then(function () {
                  // User deleted.
                  window.location.assign('/index.html')
                }).catch(function (error) {
                  // An error happened.
                });
              }
            })
        }
      })
    }
  </script>
</body>

</html>